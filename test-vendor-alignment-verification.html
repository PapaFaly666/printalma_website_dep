<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Test Alignement Vendeur - V√©rification Finale</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .preview-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .preview-box h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        .product-container {
            width: 300px;
            height: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background: white;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .design-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 2;
        }
        .delimitation {
            position: absolute;
            overflow: hidden;
            border: 2px solid blue;
        }
        .design-container {
            position: absolute;
            pointer-events: none;
            border: 2px solid green;
        }
        .design-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }
        .debug-info {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-top: 10px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .data-format {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .data-format h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .data-format pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test Alignement Vendeur - V√©rification Finale</h1>
        <p>Comparaison entre SellDesignPage (localStorage) et VendorProductsPage (base de donn√©es)</p>
        
        <div class="comparison-grid">
            <div class="preview-box">
                <h3>üìù SellDesignPage (localStorage)</h3>
                <div class="product-container" id="selldesign-preview">
                    <img src="https://via.placeholder.com/300x300/e0e0e0/999?text=T-shirt+Produit" 
                         alt="Produit" class="product-image">
                    <div class="design-overlay" id="selldesign-overlay"></div>
                </div>
                <div class="debug-info" id="selldesign-debug"></div>
            </div>
            
            <div class="preview-box">
                <h3>üõçÔ∏è VendorProductsPage (BDD)</h3>
                <div class="product-container" id="vendor-preview">
                    <img src="https://via.placeholder.com/300x300/e0e0e0/999?text=T-shirt+Produit" 
                         alt="Produit" class="product-image">
                    <div class="design-overlay" id="vendor-overlay"></div>
                </div>
                <div class="debug-info" id="vendor-debug"></div>
            </div>
            
            <div class="preview-box">
                <h3>üîç Diff√©rences</h3>
                <div id="differences-analysis" class="debug-info" style="max-height: 400px;"></div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="button" onclick="testAlignment()">üéØ Tester l'alignement</button>
            <button class="button" onclick="testWithRealData()">üìä Test avec donn√©es r√©elles</button>
            <button class="button" onclick="testDimensionCalculation()">üìê Test calcul dimensions</button>
            <button class="button" onclick="validateDataFormat()">‚úÖ Valider format donn√©es</button>
        </div>
        
        <div id="test-results"></div>
        
        <div class="data-format">
            <h4>üìã Format des Donn√©es</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <strong>localStorage (SellDesignPage):</strong>
                    <pre id="localStorage-format"></pre>
                </div>
                <div>
                    <strong>Base de donn√©es (VendorProductsPage):</strong>
                    <pre id="database-format"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Donn√©es de test bas√©es sur vos logs r√©els
        const testData = {
            // Format localStorage (SellDesignPage)
            localStorage: {
                designId: 19,
                baseProductId: 1,
                position: {
                    x: 40.39100467079473,
                    y: -36.65833503703267,
                    scale: 0.4,
                    rotation: 342.5370165902393,
                    designWidth: 90.65609092501376,
                    designHeight: 119.097217489724,
                    designScale: 1,
                    timestamp: 1752830704377
                },
                timestamp: 1752830704377,
                vendorId: 7
            },
            
            // Format base de donn√©es (VendorProductsPage)
            database: {
                designTransforms: [{
                    id: 1,
                    designUrl: "https://res.cloudinary.com/dsxab4qnu/image/upload/v1752683617/vendor-designs/vendor_7_design_1752683616684.png",
                    transforms: {
                        "0": {
                            x: 40.39100467079473,
                            y: -36.65833503703267,
                            scale: 0.4,
                            rotation: 342.5370165902393,
                            designWidth: 90.65609092501376,
                            designHeight: 119.097217489724
                        }
                    }
                }]
            },
            
            // D√©limitation commune
            delimitation: {
                x: 20, // Pourcentage
                y: 30,
                width: 60,
                height: 40,
                coordinateType: 'PERCENTAGE'
            },
            
            designUrl: "https://res.cloudinary.com/dsxab4qnu/image/upload/v1752683617/vendor-designs/vendor_7_design_1752683616684.png"
        };

        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        function calculateDelimitationPosition(delimitation, containerWidth, containerHeight) {
            const left = (delimitation.x / 100) * containerWidth;
            const top = (delimitation.y / 100) * containerHeight;
            const width = (delimitation.width / 100) * containerWidth;
            const height = (delimitation.height / 100) * containerHeight;
            return { left, top, width, height };
        }

        function renderSellDesignPageStyle(overlayId, debugId) {
            const overlay = document.getElementById(overlayId);
            const debug = document.getElementById(debugId);
            
            overlay.innerHTML = '';
            debug.textContent = '';
            
            const container = overlay.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // Calculer la position de la d√©limitation
            const delimPos = calculateDelimitationPosition(
                testData.delimitation, 
                containerRect.width, 
                containerRect.height
            );
            
            // R√©cup√©rer les transformations depuis localStorage
            const position = testData.localStorage.position;
            const { x, y, scale, rotation, designWidth, designHeight } = position;
            
            log(debugId, 'üìù SellDesignPage Style:');
            log(debugId, `  Position: x=${x.toFixed(1)}, y=${y.toFixed(1)}`);
            log(debugId, `  Dimensions: ${designWidth.toFixed(1)} x ${designHeight.toFixed(1)}px`);
            log(debugId, `  Scale: ${scale}, Rotation: ${rotation.toFixed(1)}¬∞`);
            
            // Cr√©er la d√©limitation
            const delimDiv = document.createElement('div');
            delimDiv.className = 'delimitation';
            delimDiv.style.left = `${delimPos.left}px`;
            delimDiv.style.top = `${delimPos.top}px`;
            delimDiv.style.width = `${delimPos.width}px`;
            delimDiv.style.height = `${delimPos.height}px`;
            
            // Contraintes de positionnement comme dans SellDesignPage
            const maxX = (delimPos.width - designWidth) / 2;
            const minX = -(delimPos.width - designWidth) / 2;
            const maxY = (delimPos.height - designHeight) / 2;
            const minY = -(delimPos.height - designHeight) / 2;
            const adjustedX = Math.max(minX, Math.min(x, maxX));
            const adjustedY = Math.max(minY, Math.min(y, maxY));
            
            log(debugId, `  Contraintes: maxX=${maxX.toFixed(1)}, minX=${minX.toFixed(1)}`);
            log(debugId, `  Ajust√©: x=${adjustedX.toFixed(1)}, y=${adjustedY.toFixed(1)}`);
            
            // Cr√©er le conteneur du design (comme dans SellDesignPage)
            const designContainer = document.createElement('div');
            designContainer.className = 'design-container';
            designContainer.style.left = '50%';
            designContainer.style.top = '50%';
            designContainer.style.width = `${designWidth}px`;
            designContainer.style.height = `${designHeight}px`;
            designContainer.style.transform = `translate(-50%, -50%) translate(${adjustedX}px, ${adjustedY}px) rotate(${rotation}deg)`;
            designContainer.style.transformOrigin = 'center center';
            
            // Cr√©er l'image du design
            const designImg = document.createElement('img');
            designImg.className = 'design-image';
            designImg.src = testData.designUrl;
            designImg.style.transform = 'scale(1)'; // Pas de scale suppl√©mentaire
            
            designContainer.appendChild(designImg);
            delimDiv.appendChild(designContainer);
            overlay.appendChild(delimDiv);
        }

        function renderVendorProductsPageStyle(overlayId, debugId) {
            const overlay = document.getElementById(overlayId);
            const debug = document.getElementById(debugId);
            
            overlay.innerHTML = '';
            debug.textContent = '';
            
            const container = overlay.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // Calculer la position de la d√©limitation
            const delimPos = calculateDelimitationPosition(
                testData.delimitation, 
                containerRect.width, 
                containerRect.height
            );
            
            // R√©cup√©rer les transformations depuis la base de donn√©es
            const transform = testData.database.designTransforms[0].transforms["0"];
            const { x, y, scale, rotation, designWidth, designHeight } = transform;
            
            log(debugId, 'üõçÔ∏è VendorProductsPage Style:');
            log(debugId, `  Position: x=${x.toFixed(1)}, y=${y.toFixed(1)}`);
            log(debugId, `  Dimensions: ${designWidth.toFixed(1)} x ${designHeight.toFixed(1)}px`);
            log(debugId, `  Scale: ${scale}, Rotation: ${rotation.toFixed(1)}¬∞`);
            
            // Cr√©er la d√©limitation
            const delimDiv = document.createElement('div');
            delimDiv.className = 'delimitation';
            delimDiv.style.left = `${delimPos.left}px`;
            delimDiv.style.top = `${delimPos.top}px`;
            delimDiv.style.width = `${delimPos.width}px`;
            delimDiv.style.height = `${delimPos.height}px`;
            
            // Utiliser les dimensions exactes comme dans la nouvelle impl√©mentation
            const actualDesignWidth = designWidth || (delimPos.width * scale);
            const actualDesignHeight = designHeight || (delimPos.height * scale);
            
            // Contraintes de positionnement comme dans SimpleProductPreview
            const maxX = (delimPos.width - actualDesignWidth) / 2;
            const minX = -(delimPos.width - actualDesignWidth) / 2;
            const maxY = (delimPos.height - actualDesignHeight) / 2;
            const minY = -(delimPos.height - actualDesignHeight) / 2;
            const adjustedX = Math.max(minX, Math.min(x, maxX));
            const adjustedY = Math.max(minY, Math.min(y, maxY));
            
            log(debugId, `  Dimensions r√©elles: ${actualDesignWidth.toFixed(1)} x ${actualDesignHeight.toFixed(1)}px`);
            log(debugId, `  Contraintes: maxX=${maxX.toFixed(1)}, minX=${minX.toFixed(1)}`);
            log(debugId, `  Ajust√©: x=${adjustedX.toFixed(1)}, y=${adjustedY.toFixed(1)}`);
            
            // Cr√©er le conteneur du design (nouvelle impl√©mentation)
            const designContainer = document.createElement('div');
            designContainer.className = 'design-container';
            designContainer.style.left = '50%';
            designContainer.style.top = '50%';
            designContainer.style.width = `${actualDesignWidth}px`;
            designContainer.style.height = `${actualDesignHeight}px`;
            designContainer.style.transform = `translate(-50%, -50%) translate(${adjustedX}px, ${adjustedY}px) rotate(${rotation}deg)`;
            designContainer.style.transformOrigin = 'center center';
            
            // Cr√©er l'image du design
            const designImg = document.createElement('img');
            designImg.className = 'design-image';
            designImg.src = testData.designUrl;
            designImg.style.transform = 'scale(1)'; // Pas de scale suppl√©mentaire
            
            designContainer.appendChild(designImg);
            delimDiv.appendChild(designContainer);
            overlay.appendChild(delimDiv);
        }

        function testAlignment() {
            log('selldesign-debug', 'üéØ Test d\'alignement...');
            log('vendor-debug', 'üéØ Test d\'alignement...');
            
            renderSellDesignPageStyle('selldesign-overlay', 'selldesign-debug');
            renderVendorProductsPageStyle('vendor-overlay', 'vendor-debug');
            
            // Analyser les diff√©rences
            setTimeout(() => {
                const sellDesignContainer = document.querySelector('#selldesign-overlay .design-container');
                const vendorContainer = document.querySelector('#vendor-overlay .design-container');
                
                if (sellDesignContainer && vendorContainer) {
                    const sellRect = sellDesignContainer.getBoundingClientRect();
                    const vendorRect = vendorContainer.getBoundingClientRect();
                    
                    const deltaX = Math.abs(sellRect.left - vendorRect.left);
                    const deltaY = Math.abs(sellRect.top - vendorRect.top);
                    const deltaWidth = Math.abs(sellRect.width - vendorRect.width);
                    const deltaHeight = Math.abs(sellRect.height - vendorRect.height);
                    
                    const isAligned = deltaX < 1 && deltaY < 1 && deltaWidth < 1 && deltaHeight < 1;
                    
                    const analysisDiv = document.getElementById('differences-analysis');
                    analysisDiv.textContent = `
üîç ANALYSE DES DIFF√âRENCES:

Position:
- ŒîX: ${deltaX.toFixed(2)}px
- ŒîY: ${deltaY.toFixed(2)}px

Dimensions:
- ŒîWidth: ${deltaWidth.toFixed(2)}px  
- ŒîHeight: ${deltaHeight.toFixed(2)}px

R√©sultat: ${isAligned ? '‚úÖ PARFAIT' : '‚ùå DIFF√âRENCES'}
Tol√©rance: ¬±1px

SellDesignPage:
- Position: ${sellRect.left.toFixed(1)}, ${sellRect.top.toFixed(1)}
- Taille: ${sellRect.width.toFixed(1)} x ${sellRect.height.toFixed(1)}

VendorProductsPage:
- Position: ${vendorRect.left.toFixed(1)}, ${vendorRect.top.toFixed(1)}
- Taille: ${vendorRect.width.toFixed(1)} x ${vendorRect.height.toFixed(1)}
                    `;
                    
                    const resultDiv = document.getElementById('test-results');
                    resultDiv.innerHTML = `
                        <div class="status ${isAligned ? 'success' : 'error'}">
                            ${isAligned ? '‚úÖ ALIGNEMENT PARFAIT' : '‚ùå ALIGNEMENT INCORRECT'}
                        </div>
                        <p>Diff√©rences: Position (${deltaX.toFixed(1)}, ${deltaY.toFixed(1)}px), Dimensions (${deltaWidth.toFixed(1)}, ${deltaHeight.toFixed(1)}px)</p>
                    `;
                }
            }, 100);
        }

        function testWithRealData() {
            // Utiliser les vraies donn√©es de l'utilisateur
            const realData = {
                "0": {
                    "x": 40.39100467079473,
                    "y": -36.65833503703267,
                    "scale": 0.4,
                    "rotation": 342.5370165902393,
                    "designWidth": 90.65609092501376,
                    "designHeight": 119.097217489724
                }
            };
            
            // Mettre √† jour les donn√©es de test
            testData.localStorage.position = realData["0"];
            testData.database.designTransforms[0].transforms = realData;
            
            // Relancer le test
            testAlignment();
            
            const resultDiv = document.getElementById('test-results');
            resultDiv.innerHTML += `
                <div class="status warning">
                    üìä Test avec donn√©es r√©elles effectu√©
                </div>
            `;
        }

        function testDimensionCalculation() {
            const position = testData.localStorage.position;
            const transform = testData.database.designTransforms[0].transforms["0"];
            
            const analysisDiv = document.getElementById('differences-analysis');
            analysisDiv.textContent = `
üßÆ CALCUL DES DIMENSIONS:

localStorage (SellDesignPage):
- designWidth: ${position.designWidth}px
- designHeight: ${position.designHeight}px
- scale: ${position.scale}
- Taille finale: ${position.designWidth}px x ${position.designHeight}px

Base de donn√©es (VendorProductsPage):
- designWidth: ${transform.designWidth}px
- designHeight: ${transform.designHeight}px
- scale: ${transform.scale}
- Taille finale: ${transform.designWidth}px x ${transform.designHeight}px

‚úÖ Les dimensions sont identiques!
‚úÖ Pas de calcul suppl√©mentaire n√©cessaire
‚úÖ scale(1) appliqu√© dans les deux cas
            `;
        }

        function validateDataFormat() {
            const localStorageFormat = document.getElementById('localStorage-format');
            const databaseFormat = document.getElementById('database-format');
            
            localStorageFormat.textContent = JSON.stringify(testData.localStorage, null, 2);
            databaseFormat.textContent = JSON.stringify(testData.database, null, 2);
            
            const resultDiv = document.getElementById('test-results');
            resultDiv.innerHTML = `
                <div class="status success">
                    ‚úÖ Format des donn√©es valid√©
                </div>
                <p>Les deux formats contiennent les m√™mes propri√©t√©s essentielles</p>
            `;
        }

        // Test automatique au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                testAlignment();
                validateDataFormat();
            }, 500);
        });
    </script>
</body>
</html> 