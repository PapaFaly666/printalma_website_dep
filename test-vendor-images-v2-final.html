<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Images Produits Vendeur V2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { border-color: #4CAF50; background-color: #f9fff9; }
        .error { border-color: #f44336; background-color: #fff9f9; }
        .warning { border-color: #ff9800; background-color: #fff8f0; }
        .info { border-color: #2196F3; background-color: #f0f8ff; }
        
        .product-card {
            display: inline-block;
            width: 300px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #f0f0f0;
        }
        .product-content {
            padding: 15px;
        }
        .product-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }
        .product-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
        }
        .product-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-published { background-color: #4CAF50; color: white; }
        .status-pending { background-color: #ff9800; color: white; }
        .status-draft { background-color: #9e9e9e; color: white; }
        
        .color-dots {
            display: flex;
            gap: 5px;
            margin: 8px 0;
        }
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ddd;
        }
        .logs {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #5a6fd8; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        .metric-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test Final - Images Produits Vendeur V2</h1>
            <p>V√©rification compl√®te de l'affichage des images avec l'architecture V2</p>
        </div>

        <div class="test-section info">
            <h3>üéØ Objectif du Test</h3>
            <p>Ce test v√©rifie que :</p>
            <ul>
                <li>‚úÖ L'endpoint <code>/vendor/products</code> retourne les donn√©es V2</li>
                <li>‚úÖ Les structures <code>adminProduct</code>, <code>images</code>, <code>designApplication</code> sont pr√©sentes</li>
                <li>‚úÖ Les URLs d'images Cloudinary sont valides</li>
                <li>‚úÖ Les images s'affichent correctement dans l'interface</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß Actions de Test</h3>
            <button class="btn" onclick="testVendorEndpoint()">üöÄ Tester Endpoint Vendeur</button>
            <button class="btn" onclick="testImageUrls()">üñºÔ∏è Tester URLs Images</button>
            <button class="btn" onclick="validateDataStructure()">üìã Valider Structure V2</button>
            <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Vider Logs</button>
        </div>

        <div class="grid">
            <div class="metric">
                <div class="metric-value" id="totalProducts">-</div>
                <div class="metric-label">Produits Charg√©s</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="validImages">-</div>
                <div class="metric-label">Images Valides</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="healthScore">-</div>
                <div class="metric-label">Score Sant√© (%)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="architecture">-</div>
                <div class="metric-label">Architecture</div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä R√©sultats du Test</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>üñºÔ∏è Aper√ßu des Produits</h3>
            <div id="productsPreview"></div>
        </div>

        <div class="test-section">
            <h3>üìú Logs D√©taill√©s</h3>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script>
        let testData = {
            products: [],
            totalImages: 0,
            validImages: 0,
            errors: []
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                success: '#4CAF50', 
                error: '#f44336',
                warning: '#ff9800'
            };
            
            const logElement = document.getElementById('logs');
            logElement.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('üóëÔ∏è Logs vid√©s');
        }

        async function testVendorEndpoint() {
            log('üöÄ === TEST ENDPOINT VENDEUR V2 ===', 'info');
            
            try {
                const response = await fetch('http://localhost:3004/vendor/products?status=all', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                log(`üì° Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('‚úÖ Donn√©es re√ßues avec succ√®s', 'success');
                log(`üìä Structure re√ßue: ${JSON.stringify(Object.keys(data), null, 2)}`);

                if (data.success && data.data && data.data.products) {
                    testData.products = data.data.products;
                    
                    document.getElementById('totalProducts').textContent = data.data.products.length;
                    document.getElementById('architecture').textContent = data.data.healthMetrics?.architecture || 'v2';
                    document.getElementById('healthScore').textContent = data.data.healthMetrics?.overallHealthScore || '100';
                    
                    log(`üì¶ ${data.data.products.length} produits trouv√©s`, 'success');
                    
                    // Analyser chaque produit
                    data.data.products.forEach((product, index) => {
                        log(`üîç Produit ${index + 1}: ${product.vendorName || product.originalAdminName}`);
                        log(`   - ID: ${product.id}`);
                        log(`   - Status: ${product.status}`);
                        log(`   - AdminProduct: ${!!product.adminProduct ? '‚úÖ' : '‚ùå'}`);
                        log(`   - Images: ${!!product.images ? '‚úÖ' : '‚ùå'}`);
                        log(`   - DesignApplication: ${!!product.designApplication ? '‚úÖ' : '‚ùå'}`);
                        
                        if (product.images) {
                            log(`   - Images Total: ${product.images.total || 0}`);
                            log(`   - Primary Image: ${product.images.primaryImageUrl ? '‚úÖ' : '‚ùå'}`);
                            log(`   - Admin References: ${product.images.adminReferences?.length || 0}`);
                        }
                        
                        if (product.designApplication && product.designApplication.designUrl) {
                            log(`   - Design URL: ${product.designApplication.designUrl}`, 'success');
                        }
                    });
                    
                    validateDataStructure();
                    displayProductsPreview();
                    
                } else {
                    log('‚ùå Structure de donn√©es invalide', 'error');
                    log(`Donn√©es re√ßues: ${JSON.stringify(data, null, 2)}`);
                }

            } catch (error) {
                log(`‚ùå Erreur endpoint: ${error.message}`, 'error');
                testData.errors.push(error.message);
            }
        }

        async function testImageUrls() {
            log('üñºÔ∏è === TEST VALIDATION IMAGES ===', 'info');
            
            if (testData.products.length === 0) {
                log('‚ö†Ô∏è Aucun produit charg√©, test endpoint d\'abord', 'warning');
                return;
            }

            let validImages = 0;
            let totalImages = 0;

            for (const product of testData.products) {
                // Test Primary Image
                if (product.images?.primaryImageUrl) {
                    totalImages++;
                    const isValid = await testImageUrl(product.images.primaryImageUrl, `${product.vendorName} - Primary`);
                    if (isValid) validImages++;
                }

                // Test Design URL
                if (product.designApplication?.designUrl) {
                    totalImages++;
                    const isValid = await testImageUrl(product.designApplication.designUrl, `${product.vendorName} - Design`);
                    if (isValid) validImages++;
                }

                // Test Admin References
                if (product.images?.adminReferences) {
                    for (const ref of product.images.adminReferences) {
                        if (ref.adminImageUrl) {
                            totalImages++;
                            const isValid = await testImageUrl(ref.adminImageUrl, `${product.vendorName} - ${ref.colorName}`);
                            if (isValid) validImages++;
                        }
                    }
                }

                // Test AdminProduct Images
                if (product.adminProduct?.colorVariations) {
                    for (const colorVar of product.adminProduct.colorVariations) {
                        if (colorVar.images) {
                            for (const img of colorVar.images) {
                                if (img.url) {
                                    totalImages++;
                                    const isValid = await testImageUrl(img.url, `${product.vendorName} - ${colorVar.name} Admin`);
                                    if (isValid) validImages++;
                                }
                            }
                        }
                    }
                }
            }

            testData.totalImages = totalImages;
            testData.validImages = validImages;
            
            document.getElementById('validImages').textContent = `${validImages}/${totalImages}`;
            
            const successRate = totalImages > 0 ? Math.round((validImages / totalImages) * 100) : 0;
            log(`‚úÖ Test images termin√©: ${validImages}/${totalImages} valides (${successRate}%)`, 
                successRate >= 80 ? 'success' : successRate >= 50 ? 'warning' : 'error');
        }

        async function testImageUrl(url, description) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    log(`‚úÖ ${description}: ${url}`, 'success');
                    resolve(true);
                };
                img.onerror = () => {
                    log(`‚ùå ${description}: ${url}`, 'error');
                    resolve(false);
                };
                img.src = url;
            });
        }

        function validateDataStructure() {
            log('üìã === VALIDATION STRUCTURE V2 ===', 'info');
            
            const results = [];
            
            for (const product of testData.products) {
                const validation = {
                    productId: product.id,
                    productName: product.vendorName || product.originalAdminName,
                    checks: {
                        hasAdminProduct: !!product.adminProduct,
                        hasImages: !!product.images,
                        hasDesignApplication: !!product.designApplication,
                        hasVendor: !!product.vendor,
                        hasSelectedColors: !!product.selectedColors?.length,
                        hasSelectedSizes: !!product.selectedSizes?.length,
                        hasPrimaryImage: !!product.images?.primaryImageUrl,
                        hasDesignUrl: !!product.designApplication?.designUrl
                    }
                };
                
                const score = Object.values(validation.checks).filter(Boolean).length;
                const maxScore = Object.keys(validation.checks).length;
                validation.score = Math.round((score / maxScore) * 100);
                
                results.push(validation);
                
                log(`üìä ${validation.productName}: ${validation.score}% (${score}/${maxScore})`, 
                    validation.score >= 80 ? 'success' : validation.score >= 50 ? 'warning' : 'error');
            }
            
            displayTestResults(results);
        }

        function displayTestResults(results) {
            const resultsDiv = document.getElementById('testResults');
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background-color: #f8f9fa;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">Produit</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">Score</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">AdminProduct</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">Images</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">Design</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd;">Primary Image</th>';
            html += '</tr>';
            
            results.forEach(result => {
                const scoreColor = result.score >= 80 ? '#4CAF50' : result.score >= 50 ? '#ff9800' : '#f44336';
                html += '<tr>';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${result.productName}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; color: ${scoreColor}; font-weight: bold;">${result.score}%</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${result.checks.hasAdminProduct ? '‚úÖ' : '‚ùå'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${result.checks.hasImages ? '‚úÖ' : '‚ùå'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${result.checks.hasDesignApplication ? '‚úÖ' : '‚ùå'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${result.checks.hasPrimaryImage ? '‚úÖ' : '‚ùå'}</td>`;
                html += '</tr>';
            });
            
            html += '</table>';
            resultsDiv.innerHTML = html;
        }

        function displayProductsPreview() {
            const previewDiv = document.getElementById('productsPreview');
            
            let html = '';
            
            testData.products.forEach(product => {
                const primaryImage = product.images?.primaryImageUrl || 
                                   product.designApplication?.designUrl ||
                                   product.adminProduct?.colorVariations?.[0]?.images?.[0]?.url ||
                                   '/placeholder-image.jpg';
                
                const statusClass = `status-${(product.status || 'draft').toLowerCase()}`;
                
                html += `
                    <div class="product-card">
                        <img src="${primaryImage}" alt="${product.vendorName}" class="product-image" 
                             onerror="this.src='/placeholder-image.jpg'; this.style.backgroundColor='#f0f0f0';">
                        <div class="product-content">
                            <div class="product-title">${product.vendorName || product.originalAdminName}</div>
                            <div class="product-price">${(product.price / 100).toFixed(2)} ‚Ç¨</div>
                            <div class="${statusClass} product-status">${product.status || 'DRAFT'}</div>
                            
                            ${product.selectedColors?.length ? `
                                <div class="color-dots">
                                    ${product.selectedColors.map(color => 
                                        `<div class="color-dot" style="background-color: ${color.colorCode};" title="${color.name}"></div>`
                                    ).join('')}
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                üìä Images: ${product.images?.total || 0} | 
                                üé® Design: ${product.designApplication?.hasDesign ? '‚úÖ' : '‚ùå'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            previewDiv.innerHTML = html;
        }

        // Auto-start test when page loads
        window.addEventListener('load', () => {
            log('üöÄ Page charg√©e - D√©marrage des tests automatiques');
            testVendorEndpoint();
        });
    </script>
</body>
</html> 