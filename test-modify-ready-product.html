<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modification Produit Pr√™t</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Test Modification Produit Pr√™t</h1>
    
    <div class="test-section">
        <h2>Test 1: R√©cup√©ration du produit</h2>
        <input type="number" id="productId" placeholder="ID du produit (ex: 36)" value="36">
        <button onclick="testGetProduct()">R√©cup√©rer le produit</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Modification du produit</h2>
        <input type="text" id="newName" placeholder="Nouveau nom" value="T-Shirt Modifi√©">
        <input type="text" id="newDescription" placeholder="Nouvelle description" value="Description modifi√©e">
        <input type="number" id="newPrice" placeholder="Nouveau prix" value="3000">
        <input type="number" id="newStock" placeholder="Nouveau stock" value="150">
        <button onclick="testModifyProduct()">Modifier le produit</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: V√©rification apr√®s modification</h2>
        <button onclick="testVerifyProduct()">V√©rifier le produit</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Logs</h2>
        <div id="logs"></div>
    </div>

    <script>
        let currentProduct = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        async function testGetProduct() {
            const productId = document.getElementById('productId').value;
            log(`üß™ Test 1: R√©cup√©ration du produit ${productId}`, 'info');
            
            try {
                const response = await fetch(`http://localhost:3004/products/${productId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                log(`üì° R√©ponse: ${response.status} ${response.statusText}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Erreur HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const product = await response.json();
                currentProduct = product;
                
                log(`‚úÖ Produit r√©cup√©r√©: ${product.name}`, 'success');
                log(`üìã isReadyProduct: ${product.isReadyProduct}`, 'info');
                log(`üìã Status: ${product.status}`, 'info');

                const resultDiv = document.getElementById('test1-result');
                resultDiv.innerHTML = `
                    <h3>‚úÖ Produit r√©cup√©r√©:</h3>
                    <pre>${JSON.stringify(product, null, 2)}</pre>
                `;

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        }

        async function testModifyProduct() {
            if (!currentProduct) {
                log('‚ùå Erreur: Aucun produit r√©cup√©r√©', 'error');
                return;
            }

            const productId = document.getElementById('productId').value;
            const newName = document.getElementById('newName').value;
            const newDescription = document.getElementById('newDescription').value;
            const newPrice = parseInt(document.getElementById('newPrice').value);
            const newStock = parseInt(document.getElementById('newStock').value);

            log(`üß™ Test 2: Modification du produit ${productId}`, 'info');

            // Pr√©parer les donn√©es selon la documentation
            const productData = {
                name: newName,
                description: newDescription,
                price: newPrice,
                stock: newStock,
                status: currentProduct.status.toLowerCase(),
                categories: currentProduct.categories.map(cat => cat.name),
                sizes: currentProduct.sizes.map(size => size.sizeName),
                isReadyProduct: true, // ‚Üê TOUJOURS TRUE pour les produits pr√™ts
                colorVariations: currentProduct.colorVariations.map(variation => ({
                    name: variation.name,
                    colorCode: variation.colorCode,
                    images: variation.images.map(img => {
                        // ‚úÖ G√©rer les diff√©rents types d'images selon la documentation
                        if (img.url && img.url.startsWith('http')) {
                            // Image existante avec URL
                            return {
                                url: img.url,
                                view: img.view,
                                naturalWidth: img.naturalWidth,
                                naturalHeight: img.naturalHeight
                            };
                        } else if (img.id && typeof img.id === 'number') {
                            // Image existante avec ID de base de donn√©es
                            return {
                                id: img.id,
                                view: img.view
                            };
                        } else {
                            // Image temporaire (ignor√©e)
                            console.warn(`Image temporaire ignor√©e: ${img.id}`);
                            return null;
                        }
                    }).filter(img => img !== null) // Filtrer les images null
                }))
            };

            log(`üì¶ Donn√©es de modification:`, 'info');
            log(`   - Nom: ${productData.name}`, 'info');
            log(`   - Description: ${productData.description}`, 'info');
            log(`   - Prix: ${productData.price}`, 'info');
            log(`   - Stock: ${productData.stock}`, 'info');
            log(`   - Status: ${productData.status}`, 'info');
            log(`   - isReadyProduct: ${productData.isReadyProduct}`, 'info');

            try {
                // Cr√©er FormData selon la documentation
                const formData = new FormData();
                formData.append('productData', JSON.stringify(productData));

                // Utiliser le bon endpoint selon la documentation
                const response = await fetch(`http://localhost:3004/products/ready/${productId}`, {
                    method: 'PATCH',
                    credentials: 'include',
                    body: formData
                });

                log(`üì° R√©ponse: ${response.status} ${response.statusText}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Erreur HTTP ${response.status}: ${errorText}`, 'error');
                    
                    const resultDiv = document.getElementById('test2-result');
                    resultDiv.innerHTML = `
                        <h3>‚ùå Erreur de modification:</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Message:</strong> ${errorText}</p>
                        <h4>Donn√©es envoy√©es:</h4>
                        <pre>${JSON.stringify(productData, null, 2)}</pre>
                    `;
                    return;
                }

                const result = await response.json();
                log(`‚úÖ Produit modifi√© avec succ√®s`, 'success');

                const resultDiv = document.getElementById('test2-result');
                resultDiv.innerHTML = `
                    <h3>‚úÖ Modification r√©ussie:</h3>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        }

        async function testVerifyProduct() {
            const productId = document.getElementById('productId').value;
            log(`üß™ Test 3: V√©rification du produit ${productId}`, 'info');
            
            try {
                const response = await fetch(`http://localhost:3004/products/${productId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Erreur HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const product = await response.json();
                
                log(`‚úÖ Produit v√©rifi√©: ${product.name}`, 'success');
                log(`üìã Prix: ${product.price}`, 'info');
                log(`üìã Stock: ${product.stock}`, 'info');

                const resultDiv = document.getElementById('test3-result');
                resultDiv.innerHTML = `
                    <h3>‚úÖ Produit v√©rifi√©:</h3>
                    <pre>${JSON.stringify(product, null, 2)}</pre>
                `;

            } catch (error) {
                log(`‚ùå Exception: ${error.message}`, 'error');
            }
        }

        log('üöÄ Test Modification Produit Pr√™t pr√™t', 'info');
    </script>
</body>
</html> 