<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test LocalStorage - Vendre Design</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1e40af;
        }
        .success {
            color: #059669;
            background-color: #d1fae5;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            color: #0369a1;
            background-color: #e0f2fe;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .button {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #2563eb;
        }
        .button.danger {
            background-color: #dc2626;
        }
        .button.success {
            background-color: #059669;
        }
        .output {
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
        }
        .stat-label {
            font-size: 14px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test LocalStorage - Vendre Design</h1>
            <p>V√©rification du syst√®me localStorage sans cr√©ation automatique</p>
        </div>

        <!-- Statistiques -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalDrafts">0</div>
                <div class="stat-label">Brouillons</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastActivity">-</div>
                <div class="stat-label">Derni√®re activit√©</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="storageSize">0</div>
                <div class="stat-label">Taille localStorage</div>
            </div>
        </div>

        <!-- Test 1: Cr√©ation et sauvegarde position -->
        <div class="test-section">
            <h3>üéØ Test 1: Sauvegarde Position localStorage</h3>
            <p>Teste la sauvegarde des positions sans appel API</p>
            
            <div>
                <label>Vendor ID: <input type="number" id="vendorId" value="2"></label>
                <label>Product ID: <input type="number" id="productId" value="1"></label>
                <label>Design ID: <input type="number" id="designId" value="9"></label>
            </div>
            
            <div style="margin: 10px 0;">
                <label>Position X: <input type="range" id="posX" min="0" max="1" step="0.1" value="0.5"></label>
                <span id="posXValue">0.5</span>
            </div>
            <div style="margin: 10px 0;">
                <label>Position Y: <input type="range" id="posY" min="0" max="1" step="0.1" value="0.3"></label>
                <span id="posYValue">0.3</span>
            </div>
            <div style="margin: 10px 0;">
                <label>Scale: <input type="range" id="scale" min="0.1" max="2" step="0.1" value="1"></label>
                <span id="scaleValue">1</span>
            </div>
            
            <button class="button" onclick="savePosition()">üíæ Sauvegarder Position</button>
            <button class="button" onclick="loadPosition()">üìÇ Charger Position</button>
            <button class="button danger" onclick="deletePosition()">üóëÔ∏è Supprimer Position</button>
            
            <div id="output1" class="output"></div>
        </div>

        <!-- Test 2: Gestion des brouillons -->
        <div class="test-section">
            <h3>üìã Test 2: Gestion des Brouillons</h3>
            <p>Teste la gestion des brouillons multiples</p>
            
            <button class="button" onclick="createMultipleDrafts()">‚ûï Cr√©er 5 brouillons</button>
            <button class="button" onclick="loadAllDrafts()">üìã Charger tous les brouillons</button>
            <button class="button danger" onclick="cleanupOldDrafts()">üßπ Nettoyer anciens brouillons</button>
            <button class="button danger" onclick="clearAllDrafts()">üóëÔ∏è Supprimer tout</button>
            
            <div id="output2" class="output"></div>
        </div>

        <!-- Test 3: Simulation workflow complet -->
        <div class="test-section">
            <h3>üîÑ Test 3: Workflow Complet</h3>
            <p>Simulation du workflow complet sans cr√©ation automatique</p>
            
            <button class="button" onclick="simulateWorkflow()">üé¨ Simuler workflow</button>
            <button class="button success" onclick="validateAndCreate()">‚úÖ Valider et cr√©er produit</button>
            
            <div id="output3" class="output"></div>
        </div>

        <!-- Test 4: V√©rification aucun appel API -->
        <div class="test-section">
            <h3>üö´ Test 4: V√©rification Aucun Appel API</h3>
            <p>V√©rifie qu'aucun appel API n'est fait lors du positionnement</p>
            
            <button class="button" onclick="monitorAPIRequests()">üîç Monitorer les requ√™tes</button>
            <button class="button" onclick="stopMonitoring()">‚èπÔ∏è Arr√™ter monitoring</button>
            
            <div id="output4" class="output"></div>
        </div>
    </div>

    <script>
        // Simulation du service DesignPositionService
        class DesignPositionService {
            getStorageKey(vendorId, baseProductId, designId) {
                return `design_position_${vendorId}_${baseProductId}_${designId}`;
            }

            savePosition(vendorId, baseProductId, designId, position, previewSelections) {
                const key = this.getStorageKey(vendorId, baseProductId, designId);
                const data = {
                    designId,
                    baseProductId,
                    position,
                    timestamp: Date.now(),
                    vendorId,
                    previewSelections
                };

                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    console.log('üíæ Position sauvegard√©e en localStorage:', key);
                    return true;
                } catch (error) {
                    console.error('‚ùå Erreur sauvegarde localStorage:', error);
                    return false;
                }
            }

            loadPosition(vendorId, baseProductId, designId) {
                const key = this.getStorageKey(vendorId, baseProductId, designId);
                const saved = localStorage.getItem(key);
                
                if (!saved) return null;

                try {
                    const data = JSON.parse(saved);
                    console.log('üìÇ Position restaur√©e depuis localStorage:', key);
                    return data;
                } catch (error) {
                    console.error('‚ùå Erreur parsing localStorage:', error);
                    localStorage.removeItem(key);
                    return null;
                }
            }

            deletePosition(vendorId, baseProductId, designId) {
                const key = this.getStorageKey(vendorId, baseProductId, designId);
                localStorage.removeItem(key);
                console.log('üóëÔ∏è Position supprim√©e:', key);
            }

            getAllDrafts() {
                const drafts = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('design_position_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key) || '{}');
                            drafts.push(data);
                        } catch (error) {
                            console.error('‚ùå Erreur parsing draft:', error);
                            localStorage.removeItem(key);
                        }
                    }
                }
                
                return drafts.sort((a, b) => b.timestamp - a.timestamp);
            }

            cleanupOldDrafts(maxAgeHours = 24) {
                const now = Date.now();
                const maxAge = maxAgeHours * 60 * 60 * 1000;
                let cleaned = 0;
                
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('design_position_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key) || '{}');
                            if (now - data.timestamp > maxAge) {
                                localStorage.removeItem(key);
                                cleaned++;
                                console.log(`üóëÔ∏è Draft expir√© supprim√©: ${key}`);
                            }
                        } catch (error) {
                            localStorage.removeItem(key);
                            cleaned++;
                        }
                    }
                }
                
                return cleaned;
            }
        }

        const designPositionService = new DesignPositionService();

        // Variables globales pour le test
        let apiRequestCount = 0;
        let isMonitoring = false;
        let originalFetch;

        // Mise √† jour des statistiques
        function updateStats() {
            const drafts = designPositionService.getAllDrafts();
            document.getElementById('totalDrafts').textContent = drafts.length;
            
            if (drafts.length > 0) {
                const lastTimestamp = Math.max(...drafts.map(d => d.timestamp));
                document.getElementById('lastActivity').textContent = new Date(lastTimestamp).toLocaleTimeString();
            } else {
                document.getElementById('lastActivity').textContent = '-';
            }
            
            // Calculer taille localStorage
            let totalSize = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key?.startsWith('design_position_')) {
                    totalSize += (localStorage.getItem(key) || '').length;
                }
            }
            document.getElementById('storageSize').textContent = `${(totalSize / 1024).toFixed(2)} KB`;
        }

        // Mise √† jour des sliders
        function updateSliders() {
            document.getElementById('posXValue').textContent = document.getElementById('posX').value;
            document.getElementById('posYValue').textContent = document.getElementById('posY').value;
            document.getElementById('scaleValue').textContent = document.getElementById('scale').value;
        }

        // Event listeners pour les sliders
        document.getElementById('posX').addEventListener('input', updateSliders);
        document.getElementById('posY').addEventListener('input', updateSliders);
        document.getElementById('scale').addEventListener('input', updateSliders);

        // Test 1: Sauvegarde Position
        function savePosition() {
            const vendorId = parseInt(document.getElementById('vendorId').value);
            const productId = parseInt(document.getElementById('productId').value);
            const designId = parseInt(document.getElementById('designId').value);
            
            const position = {
                x: parseFloat(document.getElementById('posX').value),
                y: parseFloat(document.getElementById('posY').value),
                scale: parseFloat(document.getElementById('scale').value),
                rotation: 0
            };
            
            const previewSelections = {
                colors: [],
                sizes: [],
                price: 25000,
                stock: 50
            };
            
            const success = designPositionService.savePosition(vendorId, productId, designId, position, previewSelections);
            
            const output = document.getElementById('output1');
            if (success) {
                output.innerHTML = `‚úÖ Position sauvegard√©e avec succ√®s!
Vendor ID: ${vendorId}
Product ID: ${productId}
Design ID: ${designId}
Position: x=${position.x}, y=${position.y}, scale=${position.scale}
Timestamp: ${new Date().toLocaleString()}
                
üíæ AUCUN APPEL API - Sauvegarde localStorage uniquement`;
                output.className = 'output success';
            } else {
                output.innerHTML = '‚ùå Erreur lors de la sauvegarde';
                output.className = 'output error';
            }
            
            updateStats();
        }

        function loadPosition() {
            const vendorId = parseInt(document.getElementById('vendorId').value);
            const productId = parseInt(document.getElementById('productId').value);
            const designId = parseInt(document.getElementById('designId').value);
            
            const saved = designPositionService.loadPosition(vendorId, productId, designId);
            
            const output = document.getElementById('output1');
            if (saved) {
                output.innerHTML = `‚úÖ Position charg√©e avec succ√®s!
Design ID: ${saved.designId}
Base Product ID: ${saved.baseProductId}
Position: x=${saved.position.x}, y=${saved.position.y}, scale=${saved.position.scale}
Timestamp: ${new Date(saved.timestamp).toLocaleString()}
Vendor ID: ${saved.vendorId}

üìÇ AUCUN APPEL API - Chargement localStorage uniquement`;
                output.className = 'output success';
                
                // Mettre √† jour les sliders
                document.getElementById('posX').value = saved.position.x;
                document.getElementById('posY').value = saved.position.y;
                document.getElementById('scale').value = saved.position.scale;
                updateSliders();
            } else {
                output.innerHTML = '‚ùå Aucune position sauvegard√©e trouv√©e';
                output.className = 'output error';
            }
            
            updateStats();
        }

        function deletePosition() {
            const vendorId = parseInt(document.getElementById('vendorId').value);
            const productId = parseInt(document.getElementById('productId').value);
            const designId = parseInt(document.getElementById('designId').value);
            
            designPositionService.deletePosition(vendorId, productId, designId);
            
            const output = document.getElementById('output1');
            output.innerHTML = `üóëÔ∏è Position supprim√©e avec succ√®s!
Vendor ID: ${vendorId}
Product ID: ${productId}
Design ID: ${designId}

üóëÔ∏è AUCUN APPEL API - Suppression localStorage uniquement`;
            output.className = 'output info';
            
            updateStats();
        }

        // Test 2: Gestion des brouillons
        function createMultipleDrafts() {
            const results = [];
            
            for (let i = 1; i <= 5; i++) {
                const position = {
                    x: Math.random(),
                    y: Math.random(),
                    scale: 0.5 + Math.random() * 1.5,
                    rotation: Math.floor(Math.random() * 360)
                };
                
                const success = designPositionService.savePosition(2, i, 9, position);
                results.push(`Draft ${i}: ${success ? '‚úÖ' : '‚ùå'}`);
            }
            
            const output = document.getElementById('output2');
            output.innerHTML = `üìã Cr√©ation de 5 brouillons:
${results.join('\n')}

üíæ AUCUN APPEL API - Cr√©ation localStorage uniquement`;
            output.className = 'output success';
            
            updateStats();
        }

        function loadAllDrafts() {
            const drafts = designPositionService.getAllDrafts();
            
            const output = document.getElementById('output2');
            if (drafts.length > 0) {
                const draftsList = drafts.map((draft, index) => 
                    `${index + 1}. Design ${draft.designId} sur produit ${draft.baseProductId}
   Position: x=${draft.position.x.toFixed(2)}, y=${draft.position.y.toFixed(2)}, scale=${draft.position.scale.toFixed(2)}
   Timestamp: ${new Date(draft.timestamp).toLocaleString()}`
                ).join('\n\n');
                
                output.innerHTML = `üìã ${drafts.length} brouillons trouv√©s:

${draftsList}

üìÇ AUCUN APPEL API - Chargement localStorage uniquement`;
                output.className = 'output success';
            } else {
                output.innerHTML = '‚ùå Aucun brouillon trouv√©';
                output.className = 'output error';
            }
            
            updateStats();
        }

        function cleanupOldDrafts() {
            const cleaned = designPositionService.cleanupOldDrafts(0.01); // 1 minute pour le test
            
            const output = document.getElementById('output2');
            output.innerHTML = `üßπ Nettoyage termin√©!
Brouillons supprim√©s: ${cleaned}

üóëÔ∏è AUCUN APPEL API - Nettoyage localStorage uniquement`;
            output.className = 'output info';
            
            updateStats();
        }

        function clearAllDrafts() {
            const drafts = designPositionService.getAllDrafts();
            
            drafts.forEach(draft => {
                designPositionService.deletePosition(draft.vendorId, draft.baseProductId, draft.designId);
            });
            
            const output = document.getElementById('output2');
            output.innerHTML = `üóëÔ∏è Tous les brouillons supprim√©s!
Nombre supprim√©: ${drafts.length}

üóëÔ∏è AUCUN APPEL API - Suppression localStorage uniquement`;
            output.className = 'output info';
            
            updateStats();
        }

        // Test 3: Workflow complet
        function simulateWorkflow() {
            const output = document.getElementById('output3');
            output.innerHTML = `üé¨ Simulation du workflow complet:

1. ‚úÖ S√©lection design (Design #9)
2. ‚úÖ Positionnement interactif (localStorage)
3. ‚úÖ Sauvegarde automatique (debounce 300ms)
4. ‚úÖ Aper√ßu temps r√©el
5. ‚è≥ En attente de validation utilisateur...

üíæ AUCUN PRODUIT CR√â√â - Tout en localStorage`;
            output.className = 'output success';
            
            // Simuler le positionnement
            designPositionService.savePosition(2, 1, 9, {
                x: 0.5,
                y: 0.3,
                scale: 1.2,
                rotation: 0
            });
            
            updateStats();
        }

        function validateAndCreate() {
            const output = document.getElementById('output3');
            output.innerHTML = `‚úÖ Validation et cr√©ation du produit final:

1. ‚úÖ Validation du formulaire
2. ‚úÖ R√©cup√©ration position depuis localStorage
3. ‚úÖ Appel API POST /vendor/products
4. ‚úÖ Produit cr√©√© en base de donn√©es
5. ‚úÖ Nettoyage localStorage
6. ‚úÖ Redirection vers le produit

üì¶ PRODUIT CR√â√â UNIQUEMENT APR√àS VALIDATION`;
            output.className = 'output success';
        }

        // Test 4: Monitoring API
        function monitorAPIRequests() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            apiRequestCount = 0;
            
            // Intercepter fetch
            originalFetch = window.fetch;
            window.fetch = function(...args) {
                apiRequestCount++;
                console.log('üö® APPEL API D√âTECT√â:', args[0]);
                
                const output = document.getElementById('output4');
                output.innerHTML = `üö® APPEL API D√âTECT√â!
URL: ${args[0]}
Nombre total d'appels: ${apiRequestCount}

‚ùå VIOLATION DU PRINCIPE LOCALSTORAGE`;
                output.className = 'output error';
                
                return originalFetch.apply(this, args);
            };
            
            const output = document.getElementById('output4');
            output.innerHTML = `üîç Monitoring des requ√™tes API activ√©...
Appels d√©tect√©s: ${apiRequestCount}

‚úÖ Aucun appel API d√©tect√© pour le moment`;
            output.className = 'output success';
        }

        function stopMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            window.fetch = originalFetch;
            
            const output = document.getElementById('output4');
            output.innerHTML = `‚èπÔ∏è Monitoring arr√™t√©.
Total d'appels API d√©tect√©s: ${apiRequestCount}

${apiRequestCount === 0 ? '‚úÖ AUCUN APPEL API - Syst√®me localStorage fonctionnel' : '‚ùå Des appels API ont √©t√© d√©tect√©s'}`;
            output.className = apiRequestCount === 0 ? 'output success' : 'output error';
        }

        // Initialisation
        updateStats();
        updateSliders();
        
        // Mise √† jour automatique des stats
        setInterval(updateStats, 5000);
        
        console.log('‚úÖ Test LocalStorage - Vendre Design initialis√©');
        console.log('üìã Utilisez les boutons pour tester le syst√®me');
    </script>
</body>
</html> 