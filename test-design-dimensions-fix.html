<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test Dimensions Design - Correction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #007bff;
        }
        .debug-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .data-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .data-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        .data-box h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .data-box pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Dimensions Design - Correction</h1>
        <p>V√©rification que designWidth et designHeight sont bien sauvegard√©es et r√©cup√©r√©es depuis la base de donn√©es</p>
        
        <div class="test-section">
            <h3>üìã 1. V√©rification des Donn√©es localStorage</h3>
            <p>V√©rifier que les dimensions sont pr√©sentes dans localStorage</p>
            <button class="button" onclick="testLocalStorage()">üîç V√©rifier localStorage</button>
            <div id="localStorage-log" class="debug-log"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ 2. Simulation Publication</h3>
            <p>Simuler le processus de publication avec les dimensions</p>
            <button class="button" onclick="simulatePublish()">üì§ Simuler Publication</button>
            <div id="publish-log" class="debug-log"></div>
        </div>

        <div class="test-section">
            <h3>üß™ 3. Test API Transformations</h3>
            <p>Tester l'envoi et la r√©cup√©ration des transformations avec dimensions</p>
            <button class="button" onclick="testTransformsAPI()">üöÄ Test API</button>
            <div id="api-log" class="debug-log"></div>
        </div>

        <div class="test-section">
            <h3>üéØ 4. V√©rification Finale</h3>
            <p>Comparer les donn√©es avant et apr√®s sauvegarde</p>
            <button class="button success" onclick="runCompleteTest()">‚úÖ Test Complet</button>
            <div id="complete-log" class="debug-log"></div>
        </div>

        <div class="data-comparison">
            <div class="data-box">
                <h4>üì• Donn√©es Entr√©e (localStorage)</h4>
                <pre id="input-data"></pre>
            </div>
            <div class="data-box">
                <h4>üì§ Donn√©es Sortie (API)</h4>
                <pre id="output-data"></pre>
            </div>
        </div>

        <div id="test-results"></div>
    </div>

    <script>
        // Donn√©es de test bas√©es sur vos logs
        const testData = {
            localStorage: {
                designId: 19,
                baseProductId: 1,
                position: {
                    x: 40.39100467079473,
                    y: -36.65833503703267,
                    scale: 0.4,
                    rotation: 342.5370165902393,
                    designWidth: 90.65609092501376,
                    designHeight: 119.097217489724,
                    designScale: 1,
                    timestamp: 1752830704377
                },
                timestamp: 1752830704377,
                vendorId: 7
            },
            product: {
                id: 1,
                name: "T-shirt Test",
                price: 25.99
            },
            designData: {
                designId: 19,
                designUrl: "https://res.cloudinary.com/dsxab4qnu/image/upload/v1752683617/vendor-designs/vendor_7_design_1752683616684.png",
                designName: "Test Design"
            }
        };

        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            element.scrollTop = element.scrollHeight;
        }

        function testLocalStorage() {
            log('localStorage-log', 'üîç V√©rification des donn√©es localStorage...');
            
            const position = testData.localStorage.position;
            
            log('localStorage-log', 'üìã Donn√©es r√©cup√©r√©es:');
            log('localStorage-log', `  Position: x=${position.x}, y=${position.y}`);
            log('localStorage-log', `  Scale: ${position.scale}`);
            log('localStorage-log', `  Rotation: ${position.rotation}¬∞`);
            log('localStorage-log', `  Dimensions: ${position.designWidth} x ${position.designHeight}px`);
            log('localStorage-log', `  DesignScale: ${position.designScale}`);
            
            // V√©rifier que les dimensions sont pr√©sentes
            const hasDimensions = position.designWidth !== undefined && position.designHeight !== undefined;
            
            if (hasDimensions) {
                log('localStorage-log', '‚úÖ Les dimensions sont pr√©sentes dans localStorage');
                document.getElementById('input-data').textContent = JSON.stringify(position, null, 2);
            } else {
                log('localStorage-log', '‚ùå Les dimensions sont manquantes dans localStorage');
            }
            
            return hasDimensions;
        }

        function simulatePublish() {
            log('publish-log', 'üì§ Simulation du processus de publication...');
            
            const position = testData.localStorage.position;
            
            // Simuler la conversion de position en transforms (ligne 155-167 de useVendorPublish.ts)
            const savedTransforms = {
                0: {
                    x: position.x,
                    y: position.y,
                    scale: position.scale,
                    rotation: position.rotation || 0,
                    designWidth: position.designWidth || 0,
                    designHeight: position.designHeight || 0,
                }
            };
            
            log('publish-log', 'üîÑ Conversion position ‚Üí transforms:');
            log('publish-log', JSON.stringify(savedTransforms, null, 2));
            
            // Simuler la cr√©ation du payload (ligne 244-246)
            const designApplication = {
                designBase64: "data:image/png;base64,iVBORw0KGgo...",
                positioning: 'CENTER',
                scale: 0.6,
                designTransforms: savedTransforms
            };
            
            log('publish-log', 'üì¶ Payload designApplication:');
            log('publish-log', JSON.stringify(designApplication, null, 2));
            
            // Simuler la r√©cup√©ration du firstTransform (ligne 327-342)
            const existingTransforms = designApplication.designTransforms || {};
            const hasExisting = Object.keys(existingTransforms).length > 0;
            
            const firstTransform = hasExisting
                ? (existingTransforms[0] || existingTransforms[Object.keys(existingTransforms)[0]])
                : {
                    x: position.x,
                    y: position.y,
                    scale: position.scale,
                    rotation: position.rotation || 0,
                    designWidth: position.designWidth,
                    designHeight: position.designHeight
                };
            
            log('publish-log', 'üéØ FirstTransform pour API:');
            log('publish-log', JSON.stringify(firstTransform, null, 2));
            
            // V√©rifier que les dimensions sont bien pr√©sentes
            const dimensionsPresent = firstTransform.designWidth !== undefined && firstTransform.designHeight !== undefined;
            
            if (dimensionsPresent) {
                log('publish-log', '‚úÖ Les dimensions sont pr√©sentes dans firstTransform');
                document.getElementById('output-data').textContent = JSON.stringify(firstTransform, null, 2);
            } else {
                log('publish-log', '‚ùå Les dimensions sont manquantes dans firstTransform');
            }
            
            return dimensionsPresent;
        }

        async function testTransformsAPI() {
            log('api-log', 'üöÄ Test de l\'API designTransforms...');
            
            const position = testData.localStorage.position;
            
            // Simuler l'appel API saveDesignTransforms
            const apiPayload = {
                vendorProductId: 285,
                designUrl: testData.designData.designUrl,
                transforms: {
                    '0': {
                        x: position.x,
                        y: position.y,
                        scale: position.scale,
                        rotation: position.rotation || 0,
                        designWidth: position.designWidth,
                        designHeight: position.designHeight
                    }
                },
                lastModified: Date.now()
            };
            
            log('api-log', 'üì§ Payload API:');
            log('api-log', JSON.stringify(apiPayload, null, 2));
            
            try {
                // Simuler l'appel API
                log('api-log', 'üåê Simulation appel POST /vendor/design-transforms/save...');
                
                // Simuler la r√©ponse
                const mockResponse = {
                    success: true,
                    data: {
                        id: 123,
                        transforms: apiPayload.transforms,
                        designUrl: apiPayload.designUrl,
                        vendorProductId: apiPayload.vendorProductId
                    }
                };
                
                log('api-log', '‚úÖ R√©ponse simul√©e:');
                log('api-log', JSON.stringify(mockResponse, null, 2));
                
                // V√©rifier que les dimensions sont pr√©serv√©es
                const savedTransform = mockResponse.data.transforms['0'];
                const dimensionsPreserved = savedTransform.designWidth !== undefined && savedTransform.designHeight !== undefined;
                
                if (dimensionsPreserved) {
                    log('api-log', '‚úÖ Les dimensions sont pr√©serv√©es dans la r√©ponse API');
                    log('api-log', `  Dimensions sauvegard√©es: ${savedTransform.designWidth} x ${savedTransform.designHeight}px`);
                } else {
                    log('api-log', '‚ùå Les dimensions sont perdues dans la r√©ponse API');
                }
                
                return dimensionsPreserved;
                
            } catch (error) {
                log('api-log', `‚ùå Erreur API: ${error.message}`);
                return false;
            }
        }

        async function runCompleteTest() {
            log('complete-log', 'üéØ D√©marrage du test complet...');
            
            // Test 1: localStorage
            log('complete-log', '1Ô∏è‚É£ Test localStorage...');
            const localStorageOK = testLocalStorage();
            log('complete-log', `   R√©sultat: ${localStorageOK ? '‚úÖ OK' : '‚ùå √âCHEC'}`);
            
            // Test 2: Publication
            log('complete-log', '2Ô∏è‚É£ Test publication...');
            const publishOK = simulatePublish();
            log('complete-log', `   R√©sultat: ${publishOK ? '‚úÖ OK' : '‚ùå √âCHEC'}`);
            
            // Test 3: API
            log('complete-log', '3Ô∏è‚É£ Test API...');
            const apiOK = await testTransformsAPI();
            log('complete-log', `   R√©sultat: ${apiOK ? '‚úÖ OK' : '‚ùå √âCHEC'}`);
            
            // R√©sultat final
            const allTestsOK = localStorageOK && publishOK && apiOK;
            
            log('complete-log', '');
            log('complete-log', 'üèÅ R√âSULTAT FINAL:');
            log('complete-log', `   localStorage: ${localStorageOK ? '‚úÖ' : '‚ùå'}`);
            log('complete-log', `   Publication: ${publishOK ? '‚úÖ' : '‚ùå'}`);
            log('complete-log', `   API: ${apiOK ? '‚úÖ' : '‚ùå'}`);
            log('complete-log', '');
            log('complete-log', allTestsOK ? 'üéâ TOUS LES TESTS R√âUSSIS!' : '‚ö†Ô∏è CERTAINS TESTS ONT √âCHOU√â');
            
            // Afficher le r√©sultat
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `
                <div class="status ${allTestsOK ? 'success' : 'error'}">
                    ${allTestsOK ? '‚úÖ CORRECTION R√âUSSIE' : '‚ùå PROBL√àME D√âTECT√â'}
                </div>
                <p>
                    ${allTestsOK 
                        ? 'Les dimensions designWidth et designHeight sont correctement transmises √† la base de donn√©es.' 
                        : 'Il y a encore des probl√®mes avec la transmission des dimensions.'}
                </p>
                <div style="margin-top: 15px;">
                    <strong>D√©tails:</strong><br>
                    ‚Ä¢ localStorage ‚Üí transforms: ${localStorageOK ? '‚úÖ' : '‚ùå'}<br>
                    ‚Ä¢ transforms ‚Üí API payload: ${publishOK ? '‚úÖ' : '‚ùå'}<br>
                    ‚Ä¢ API ‚Üí base de donn√©es: ${apiOK ? '‚úÖ' : '‚ùå'}
                </div>
            `;
            
            // Highlight des dimensions dans les donn√©es
            if (allTestsOK) {
                const inputData = document.getElementById('input-data');
                const outputData = document.getElementById('output-data');
                
                if (inputData.textContent) {
                    inputData.innerHTML = inputData.textContent
                        .replace(/"designWidth": ([0-9.]+)/g, '"designWidth": <span class="highlight">$1</span>')
                        .replace(/"designHeight": ([0-9.]+)/g, '"designHeight": <span class="highlight">$1</span>');
                }
                
                if (outputData.textContent) {
                    outputData.innerHTML = outputData.textContent
                        .replace(/"designWidth": ([0-9.]+)/g, '"designWidth": <span class="highlight">$1</span>')
                        .replace(/"designHeight": ([0-9.]+)/g, '"designHeight": <span class="highlight">$1</span>');
                }
            }
        }

        // Auto-test au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                runCompleteTest();
            }, 1000);
        });
    </script>
</body>
</html> 